<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>RAGnetic Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet" />

  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', path='css/style.css') }}">
</head>
<body>
    <div id="toast-notification"></div>
    <div id="confirmation-modal">
        <div class="modal-content">
            <p id="modal-text">Are you sure?</p>
            <div class="modal-buttons">
                <button id="modal-cancel-btn" class="modal-btn cancel">Cancel</button>
                <button id="modal-confirm-btn" class="modal-btn confirm">Confirm</button>
            </div>
        </div>
    </div>

    <aside id="chat-history-sidebar">
        <div class="sidebar-top">
            <button id="new-chat-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
                <span>New Chat</span>
            </button>
            <select id="agent-select" name="agent">
                {% for a in agents %}
                <option value="{{ a.name }}" {% if a.name == agent %}selected{% endif %}>{{ a.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        <h3 class="history-heading">Recent</h3>
        <ul id="history-list"></ul>
    </aside>

    <div id="chat-container">
        <div id="messages"></div>

        <div id="input-form-container">
            <div id="typing-indicator" style="opacity: 0; display:none;">
                <div class="pulsing-dot"></div>
                <span>RAGnetic is thinking...</span>
            </div>
            <form id="input-form" onsubmit="handleFormSubmit(event)">
                <textarea name="query" id="query-input" placeholder="Ask RAGneticâ€¦" rows="1"></textarea>
                <button type="submit" id="send-stop-btn">
                    <span id="send-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg></span>
                    <span id="stop-icon" style="display: none;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M6 6h12v12H6V6z"></path></svg></span>
                </button>
            </form>
            <p class="disclaimer-text">RAGnetic can make mistakes. Double check your source.</p>
        </div>
    </div>

    <script>
        const GLOBAL_API_KEY = "{{ api_key }}";
        const agentSelect = document.getElementById('agent-select');
        const messagesDiv = document.getElementById('messages');
        const inputField = document.getElementById('query-input');
        const sendStopButton = document.getElementById('send-stop-btn');
        const sendIcon = document.getElementById('send-icon');
        const stopIcon = document.getElementById('stop-icon');
        const typingIndicator = document.getElementById('typing-indicator');
        const newChatButton = document.getElementById('new-chat-btn');
        const toastNotification = document.getElementById('toast-notification');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalText = document.getElementById('modal-text');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const historySidebar = document.getElementById('chat-history-sidebar');
        const historyList = document.getElementById('history-list');

        let agent, user_id, thread_id, socket;
        let isFirstMessage = true;
        let confirmCallback = null;
        let isGenerating = false;
        const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
        const svgs = {
            copy: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M7.5 3a.75.75 0 00-.75.75v13.5a.75.75 0 00.75.75h9a.75.75 0 00.75-.75V3.75A.75.75 0 0016.5 3h-9zM8.25 4.5h7.5v12h-7.5V4.5z" /><path d="M6 1.5a.75.75 0 00-.75.75V16.5a.75.75 0 00.75.75h.008a.75.75 0 00.75-.75V2.25A.75.75 0 006.008 1.5H6z" /></svg>`,
            copied: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd" /></svg>`
        };

        function renderMath(element) { if (window.MathJax) { window.MathJax.typesetPromise(element ? [element] : []).catch((err) => console.error('MathJax typesetting error:', err)); } }
        function showToast(message, isError = false) { toastNotification.textContent = message; toastNotification.className = isError ? 'error' : 'success'; toastNotification.style.display = 'block'; setTimeout(() => { toastNotification.style.display = 'none'; }, 4000); }

        function scrollToBottom() { window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); }

        function setGeneratingState(generating) { isGenerating = generating; sendIcon.style.display = generating ? 'none' : 'inline'; stopIcon.style.display = generating ? 'inline' : 'none'; inputField.disabled = generating; sendStopButton.classList.toggle('stop-active', generating); if (!generating) { typingIndicator.style.display = 'none'; inputField.focus(); } }
        function renderEmptyState() { messagesDiv.innerHTML = `<div id="empty-state"><h1>RAG<span>netic</span></h1><p>Your on-premise AI assistant. Select an agent and ask a question to begin.</p></div>`; }
        function openWebSocket(onOpenCallback) { if (socket && socket.readyState !== WebSocket.CLOSED) { socket.close(1000, "Starting new session"); } let wsUrl = `${protocol}://${location.host}/ws`; if (GLOBAL_API_KEY) { wsUrl += `?api_key=${GLOBAL_API_KEY}`; } socket = new WebSocket(wsUrl); isFirstMessage = true; socket.onopen = () => { sendStopButton.disabled = false; if (onOpenCallback) { onOpenCallback(); } }; socket.onerror = (event) => { console.error("WebSocket error:", event); showToast("Connection error. Check console for details.", true); }; socket.onclose = (event) => { sendStopButton.disabled = true; if (isGenerating) setGeneratingState(false); if (event.code === 1008) { showToast("Connection rejected: Invalid or missing API Key.", true); } else if (event.code !== 1000) { showToast(`WebSocket disconnected: Code ${event.code}`, true); } }; socket.onmessage = (event) => { const data = JSON.parse(event.data); if (data.token) { typingIndicator.style.display = 'none'; appendAgentToken(data.token); } if (data.done) { setGeneratingState(false); if (data.is_first_message) { user_id = data.user_id; thread_id = data.thread_id; localStorage.setItem('ragnetic_user_id', user_id); localStorage.setItem('ragnetic_thread_id', thread_id); localStorage.setItem('ragnetic_agent', agent); isFirstMessage = false; fetchChatSessions(agent); } const lastMessage = messagesDiv.lastElementChild; if (lastMessage && lastMessage.classList.contains('agent')) { lastMessage.dataset.streaming = 'false'; renderCodeblocks(lastMessage); renderMath(lastMessage); } } }; }
        function handleFormSubmit(event) { if (event) event.preventDefault(); if (isGenerating) { socket.send(JSON.stringify({ type: 'interrupt' })); setGeneratingState(false); } else { sendMessage(); } }
        function sendMessage() { const query = inputField.value.trim(); if (!query) return; const payload = { agent, user_id, thread_id, query }; const message = { type: 'query', payload: payload }; const doSend = () => { socket.send(JSON.stringify(message)); const emptyState = document.getElementById('empty-state'); if (emptyState) emptyState.remove(); appendUserMessage(query); setGeneratingState(true); typingIndicator.style.opacity = '1'; typingIndicator.style.display = 'flex'; scrollToBottom(); inputField.value = ''; inputField.style.height = 'auto'; }; if (!socket || socket.readyState !== WebSocket.OPEN) { showToast("Connecting... Please try again shortly."); openWebSocket(doSend); } else { doSend(); } }
        function appendUserMessage(text) { const msg = document.createElement('div'); msg.className = 'message user'; msg.textContent = text; messagesDiv.appendChild(msg); scrollToBottom(); }
        function createAgentMessageBubble() { const bubble = document.createElement('div'); bubble.className = 'message agent'; const contentDiv = document.createElement('div'); contentDiv.className = 'content'; bubble.appendChild(contentDiv); const copyBtn = document.createElement('button'); copyBtn.className = 'copy-btn'; copyBtn.innerHTML = svgs.copy; copyBtn.onclick = (e) => { const rawMarkdown = e.currentTarget.closest('.message.agent').dataset.rawMarkdown; if (rawMarkdown) { navigator.clipboard.writeText(rawMarkdown).then(() => { e.currentTarget.innerHTML = svgs.copied; setTimeout(() => { e.currentTarget.innerHTML = svgs.copy; }, 2000); }); } }; bubble.appendChild(copyBtn); bubble.dataset.rawMarkdown = ''; messagesDiv.appendChild(bubble); return bubble; }
        function renderCodeblocks(scopeElement) { scopeElement.querySelectorAll('pre > code').forEach((codeBlock) => { const pre = codeBlock.parentElement; if (pre.querySelector('.code-header')) return; const lang = codeBlock.className.split('-')[1] || 'text'; const header = document.createElement('div'); header.className = 'code-header'; const langSpan = document.createElement('span'); langSpan.textContent = lang; const copyBtn = document.createElement('button'); copyBtn.className = 'code-copy-btn'; copyBtn.textContent = 'Copy'; copyBtn.onclick = () => { navigator.clipboard.writeText(codeBlock.textContent).then(() => { copyBtn.textContent = 'Copied!'; setTimeout(() => { copyBtn.textContent = 'Copy'; }, 2000); }); }; header.appendChild(langSpan); header.appendChild(copyBtn); pre.insertBefore(header, codeBlock); }); }
        function appendAgentToken(token) { let lastMessage = messagesDiv.lastElementChild; if (!lastMessage || !lastMessage.classList.contains('agent') || lastMessage.dataset.streaming === 'false') { typingIndicator.style.display = 'none'; lastMessage = createAgentMessageBubble(); lastMessage.dataset.streaming = 'true'; } lastMessage.dataset.rawMarkdown += token; const contentDiv = lastMessage.querySelector('.content'); if (contentDiv) { contentDiv.innerHTML = marked.parse(lastMessage.dataset.rawMarkdown); renderCodeblocks(contentDiv); } scrollToBottom(); }
        async function loadHistory(agentName, threadId, userId) { try { const response = await fetch(`/history/${threadId}?agent_name=${agentName}&user_id=${userId}&api_key=${GLOBAL_API_KEY}`); if (!response.ok) { showToast(`Could not load session (status: ${response.status}).`, true); startNewSession(false); return; } const history = await response.json(); messagesDiv.innerHTML = ''; history.forEach(msg => { if (msg.type === 'human') appendUserMessage(msg.content); else if (msg.type === 'ai') { const agentMsgBubble = createAgentMessageBubble(); agentMsgBubble.dataset.rawMarkdown = msg.content; const contentDiv = agentMsgBubble.querySelector('.content'); contentDiv.innerHTML = marked.parse(msg.content); agentMsgBubble.dataset.streaming = 'false'; renderCodeblocks(contentDiv); renderMath(contentDiv); } }); setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100); } catch (error) { console.error("Failed to fetch history:", error); showToast("Could not connect to server to load session.", true); } }

        async function fetchChatSessions(agentName) {
            if (!user_id || !GLOBAL_API_KEY) {
                historyList.innerHTML = '';
                return;
            }
            try {
                const response = await fetch(`/sessions?agent_name=${agentName}&user_id=${user_id}&api_key=${GLOBAL_API_KEY}`);
                if (!response.ok) { throw new Error('Failed to fetch chat sessions.'); }
                const sessions = await response.json();
                historyList.innerHTML = '';
                sessions.forEach(session => {
                    const li = document.createElement('li');
                    li.dataset.threadId = session.thread_id;
                    li.dataset.topicName = session.topic_name;

                    const mainContent = document.createElement('div');
                    mainContent.className = 'history-item-main';
                    mainContent.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="history-icon" viewBox="0 0 16 16"><path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/></svg>
                        <span class="history-item-text">${session.topic_name}</span>
                        <input type="text" class="rename-input" style="display: none;" />
                    `;
                    li.appendChild(mainContent);

                    const actionsContainer = document.createElement('div');
                    actionsContainer.className = 'history-item-actions';
                    actionsContainer.innerHTML = `
                        <button class="action-btn rename-btn" title="Rename Chat">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>
                        </button>
                        <button class="action-btn delete-btn" title="Delete Chat">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/><path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/></svg>
                        </button>
                    `;
                    li.appendChild(actionsContainer);

                    if (session.thread_id === thread_id) { li.classList.add('active'); }

                    mainContent.onclick = () => {
                        if (li.classList.contains('editing')) return;
                        document.querySelectorAll('#history-list li').forEach(item => item.classList.remove('active'));
                        li.classList.add('active');
                        thread_id = session.thread_id;
                        localStorage.setItem('ragnetic_thread_id', thread_id);
                        loadHistory(agent, thread_id, user_id);
                    };

                    addRenameFunctionality(li, session.thread_id);
                    addDeleteFunctionality(li, session.thread_id);

                    historyList.appendChild(li);
                });
            } catch (error) {
                console.error("Failed to fetch chat sessions:", error);
                historyList.innerHTML = `<li class="no-history"><p>No chat history available.</p></li>`;
            }
        }

        function addRenameFunctionality(liElement, currentThreadId) {
            const renameButton = liElement.querySelector('.rename-btn');
            const textSpan = liElement.querySelector('.history-item-text');
            const renameInput = liElement.querySelector('.rename-input');

            renameButton.onclick = (e) => {
                e.stopPropagation();
                liElement.classList.add('editing');
                renameInput.style.display = 'block';
                textSpan.style.display = 'none';
                renameInput.value = textSpan.textContent;
                renameInput.focus();
            };

            const finishEditing = async () => {
                const newName = renameInput.value.trim();
                const oldName = textSpan.textContent;

                if (newName && newName !== oldName) {
                    try {
                        const response = await fetch(`/sessions/${currentThreadId}/rename?agent_name=${agent}&user_id=${user_id}&api_key=${GLOBAL_API_KEY}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ new_name: newName })
                        });
                        if (!response.ok) throw new Error('Failed to rename session.');
                        textSpan.textContent = newName;
                        showToast('Chat renamed successfully!');
                    } catch (error) {
                        console.error('Rename failed:', error);
                        showToast('Error: Could not rename chat.', true);
                    }
                }
                liElement.classList.remove('editing');
                renameInput.style.display = 'none';
                textSpan.style.display = 'block';
            };

            renameInput.onblur = finishEditing;
            renameInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishEditing();
                } else if (e.key === 'Escape') {
                    liElement.classList.remove('editing');
                    renameInput.style.display = 'none';
                    textSpan.style.display = 'block';
                }
            };
        }

        function addDeleteFunctionality(liElement, currentThreadId) {
            const deleteButton = liElement.querySelector('.delete-btn');
            deleteButton.onclick = (e) => {
                e.stopPropagation();
                showConfirmationModal(() => {
                    deleteChatSession(liElement, currentThreadId);
                }, "Are you sure you want to delete this chat?", "Delete");
            };
        }

        async function deleteChatSession(liElement, currentThreadId) {
            try {
                const response = await fetch(`/sessions/${currentThreadId}?agent_name=${agent}&user_id=${user_id}&api_key=${GLOBAL_API_KEY}`, {
                    method: 'DELETE'
                });
                if (!response.ok) { throw new Error('Failed to delete session.'); }

                showToast('Chat deleted successfully!');
                liElement.remove();

                if (thread_id === currentThreadId) {
                    startNewSession();
                }
            } catch(error) {
                console.error("Delete failed:", error);
                showToast('Error: Could not delete chat.', true);
            }
        }

        function showConfirmationModal(onConfirm, text = "Are you sure?", confirmText = "Start New") {
             // Your original logic for checking the empty state was good for the 'New Chat' button,
             // but it blocked other confirmations (like delete). This is the corrected version.
            if (confirmText === "Start New" && (messagesDiv.children.length === 0 || document.getElementById('empty-state'))) {
                onConfirm();
                return;
            }
            modalText.textContent = text;
            modalConfirmBtn.textContent = confirmText;
            modalConfirmBtn.className = confirmText === "Delete" ? 'modal-btn confirm error' : 'modal-btn confirm';

            confirmCallback = onConfirm;
            confirmationModal.style.display = 'flex';
        }

        function startNewSession(openConnection = true) {
            localStorage.removeItem('ragnetic_thread_id');
            thread_id = "";
            renderEmptyState();
            if (openConnection) openWebSocket();
            fetchChatSessions(agent);
        }

        document.addEventListener('DOMContentLoaded', () => {
          const savedAgent    = localStorage.getItem('ragnetic_agent');
          const savedThreadId = localStorage.getItem('ragnetic_thread_id');
          const savedUserId   = localStorage.getItem('ragnetic_user_id');

          if (savedAgent) agentSelect.value = savedAgent;
          agent = agentSelect.value;
          user_id = savedUserId || `user-${Date.now()}`;
          localStorage.setItem('ragnetic_user_id', user_id);

          if (GLOBAL_API_KEY && user_id) {
            if (savedThreadId) {
                thread_id = savedThreadId;
                loadHistory(agent, thread_id, user_id);
            } else {
                renderEmptyState();
            }
            fetchChatSessions(agent);
          } else {
            renderEmptyState();
          }

          openWebSocket();
        });

        newChatButton.addEventListener('click', () => showConfirmationModal(startNewSession, "Start a new chat?", "Start New"));
        agentSelect.addEventListener('change', () => showConfirmationModal(() => { agent = agentSelect.value; localStorage.setItem('ragnetic_agent', agent); startNewSession(); }, "Change agent and start a new chat?", "Change Agent"));

        modalCancelBtn.addEventListener('click', () => { confirmationModal.style.display = 'none'; confirmCallback = null; });
        modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); confirmationModal.style.display = 'none'; confirmCallback = null; });
        inputField.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleFormSubmit(); } });
        inputField.addEventListener('input', () => { inputField.style.height = 'auto'; inputField.style.height = `${inputField.scrollHeight}px`; });

    </script>
</body>
</html>